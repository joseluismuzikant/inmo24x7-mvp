name: Build (auto) + Deploy to DigitalOcean (manual)

on:
  push:
    # ✅ build de cualquier rama (para poder desplegar “cualquier build” a mano)
    branches: ["**"]

  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (latest | sha-<commit> | branch-<branch>)"
        required: false
        default: "latest"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}   # ej: joseluismuzikant/inmo24x7-api
  CONTAINER_NAME: inmo24x7-api
  # OJO: NO usar ~ acá porque en el droplet lo vamos a expandir con $HOME
  DROPLET_ENV_FILE: inmo24x7-api/.env

jobs:
  build:
    name: Build & Push to GHCR
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ armamos tag de rama compatible con Docker (reemplaza / por -)
      - name: Compute branch tag
        id: vars
        run: |
          BRANCH="${GITHUB_REF_NAME//\//-}"
          APP_VERSION="$(node -p "require('./package.json').version")"
          echo "branch_tag=branch-${BRANCH}" >> $GITHUB_OUTPUT
          echo "app_version=${APP_VERSION}" >> $GITHUB_OUTPUT
          echo "app_commit_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            APP_VERSION=${{ steps.vars.outputs.app_version }}
            APP_COMMIT_SHA=${{ steps.vars.outputs.app_commit_sha }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.branch_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to DigitalOcean (manual)
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          script: |
            set -euo pipefail

            TAG="${{ inputs.tag }}"
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"

            echo "Deploying ${IMAGE}"

            # Expandimos ruta real del env file en el droplet
            ENV_FILE="$HOME/${{ env.DROPLET_ENV_FILE }}"

            # Validar env file en droplet
            if [ ! -f "$ENV_FILE" ]; then
              echo "ERROR: No existe el env file en el droplet: $ENV_FILE"
              echo "Crealo con PORT, OPENAI_API_KEY, OPENAI_MODEL, PROPERTY_LOADER, SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY"
              exit 1
            fi

            # Leer PORT del env file (para mapear el puerto host:container)
            set -a
            . "$ENV_FILE"
            set +a
            PORT="${PORT:-3000}"

            # Login a GHCR desde el droplet (PAT)
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

            # (Opcional pero útil) validar que el tag exista
            if ! docker manifest inspect "${IMAGE}" >/dev/null 2>&1; then
              echo "ERROR: La imagen/tag no existe en GHCR: ${IMAGE}"
              echo "Asegurate de haber pusheado esa rama/commit para que se buildée y publique."
              exit 1
            fi

            docker pull "${IMAGE}"

            mkdir -p "$HOME/inmo24x7-api/data"

            docker stop "${{ env.CONTAINER_NAME }}" || true
            docker rm "${{ env.CONTAINER_NAME }}" || true

            docker run -d \
              --name "${{ env.CONTAINER_NAME }}" \
              --restart unless-stopped \
              -p "127.0.0.1:${PORT}:${PORT}" \
              --env-file "$ENV_FILE" \
              -v "$HOME/inmo24x7-api/data:/app/data" \
              "${IMAGE}" \
              node --experimental-specifier-resolution=node dist/index.js

            docker image prune -f
            docker ps --filter "name=${{ env.CONTAINER_NAME }}"
